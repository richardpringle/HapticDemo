<!doctype html>
<html>
  
  <head>
    <meta name="mobile-web-app-capable" content="yes">
    <title>app</title>
    <style type="text/css">
      html, body, canvas {
        height: 100%;
        width: 100%;
        margin: 0;
      }
      #viewport {
        position: relative;
        height: 100%;
        background: #1d1f20;
      }
    </style>

    <script src="/js/socket.io-1.2.0.js"></script>
    <script src="/js/jquery-1.11.1.js"></script>
    <script src="/js/paper-full.js"></script>
    <script type="text/paperscript" canvas="myCanvas">
      var socket = io();

      var x = [];
      var y = [];

      // window
      var width = view.bounds.width;
      var height = view.bounds.height;
      var size = 1;
      var urchin_radius = 20;

      // slingshot
      var arm_size = 350;          

      var createCircle = function (x, y, r, color) {
        return new Shape.Circle({
          center: new Point(x,y),
          radius: r,
          strokeColor: color,
          fillColor: color
        });
      };

      var random = function (a, b) { 
        return a + (Math.random() * (b - a)); 
      };

      // Solve for y given circle radius and x 
      var circle_y = function (x, rad) {
        return Math.sqrt(Math.pow(rad, 2) - Math.pow(x, 2));
      };

      // Function to create a slingshot line segment 
      var segment = function (x1, y1, x2, y2) {
        var seg = new Path();
        seg.strokeColor = 'coral';
        seg.strokeWidth = 30;
        seg.opacity = 0.8;
        // Add the starting location 
        seg.add(new Point(x1, y1));
        // Add segments between start and end
        var unit = (x2 - x1) / 5.0;
        for (var i = 1; i < 5; i++) {
          // Make them deviate a little in the y direction 
          seg.add(new Point(x1 + i * unit, y1 + Math.random() * 20));
        }
        // Add the end location 
        seg.add(new Point(x2, y2));
        seg.strokeCap = 'round';
        seg.opacity = 0.5;
      };

      // Have a different setup based on chosen slingshot arm separation size
      var setup = function (size, width, height, radius, arm_size) {
        var components = {};

        // Where the spring/slingshot base starts off at 
        components.start = {};

        // Used to position the arms 
        var mid = height / 2;
        var a = mid + ((size / 2.0) * mid);
        var b = mid - ((size / 2.0) * mid);

        // Slingshot arms (made of coral)
        components.armTop = {
          x1: 0, y1: a, x2: arm_size, y2: a,
          create: function () { return segment(this.x1, this.y1, this.x2, this.y2); }
        };
        components.armBottom = {
          x1: 0, y1: b, x2: arm_size, y2: b,
          create: function () { segment(this.x1, this.y1, this.x2, this.y2); }
        };
        
        // Slingshot 
        components.slingshot = function () {
          var slingshot = new Path();
          // Add an extra 15 - this is half the size of the coral arm width 
          // allows seaweed to 'wrap around' arm 
            slingshot.add(new Point(arm_size, a + 15));

            // Where the urchin will be nestled to start with 
            components.start.x = arm_size - 20;
            components.start.y = a - ((a - b) / 2);
            slingshot.apex = slingshot.add(new Point(components.start.x, components.start.y));

          slingshot.add(new Point(arm_size, b - 15));
          
          slingshot.strokeColor = 'green';
          slingshot.strokeWidth = 10;
          slingshot.smooth();
          slingshot.strokeCap = 'butt';
          return slingshot;
        };

        // The urchin center is slightly offset from the center of the slingshot 
        components.urchin_radius = radius;
        components.urchin_center = null;
        components.urchin = function () {
          components.urchin_center = center = {x: components.start.x + 20, y: components.start.y - 8};

          // Add spikes to urchin 
          var spikes = [];
          for (var i = 0; i < 200; i++) {
            var s = spike(center, components.urchin_radius);
            s.rotate(Math.random() * 500);
            spikes.push(s);
          }

          var body = new Group(spikes);
          body.fillColor = 'black';
          body.opacity = 0.6;
          body.position = center;

          // Add eyes to urchin 
          var eye1 = new Path.Circle(new Point(center.x - 5, center.y), 8);
          var eye2 = new Path.Circle(new Point(center.x + 5, center.y), 8);
          var inner1 = new Path.Circle(new Point(center.x - 5, center.y), 2);
          var inner2 = new Path.Circle(new Point(center.x + 5, center.y), 2);
          var outers = new Group(eye1, eye2);
          var inners = new Group(inner1, inner2);
          outers.fillColor = 'black';
          inners.fillColor = 'white';
          var eyes = new Group(outers, inners);

          var group = new Group(body, eyes, inners);;
          var urchin = {body: body, eyes: eyes, inners: inners, group: group}
          return urchin;
        };

        // Fish target 
        components.fish = function (size) {
          var body = new Path();
          // TODO 
        };

        // Eel - direction is 1 or -1 
        components.eel = function (specs) {
          var body = new Path(specs.p);
          var back = new Path(specs.p);
          // Add segments to the eel body, each of size 'size'
          var point;
          for (var i = 1; i < 4; i++) {
            point = new Point(specs.p.x, specs.p.y + specs.dir * specs.size * i)
            body.add(point);
            back.add(point);
          }
          // Add the eyes 
          var lefteye = new Path.Circle(new Point(specs.p.x - 5, specs.p.y), 6);
          var righteye = new Path.Circle(new Point(specs.p.x + 5, specs.p.y), 6);
          var eyes = new Group(lefteye, righteye);
          eyes.fillColor = 'black';
          // Add the tip of the tail 
          var p = body.segments[3].point;
          var end = new Point(p.x, p.y - (specs.size / 2));
          var tail = new Path(new Point(p.x - 10, p.y), end, new Point(p.x + 10, p.y));
          // Add a little head 
          p = body.segments[0].point;
          var start = new Point(p.x, p.y + 10);
          var head = new Path(new Point(p.x - 10, p.y), start, new Point(p.x + 10, p.y));
          // Stylings
          var group = new Group(body, back, eyes, tail);
          body.smooth(); back.smooth(); tail.smooth(); head.smooth();
          body.strokeColor = 'green'; tail.fillColor = 'green'; head.fillColor = 'green';
          back.strokeColor = 'black';
          body.strokeWidth = 20; 
          back.strokeWidth = 5;
          body.opacity = 0.5; back.opacity = 0.5; tail.opacity = 0.5; eyes.opacity = 0.5; head.opacity = 0.5;
          back.strokeCap = 'round';
          this.body = body;
          this.back = back;
          this.eyes = eyes;
          this.tail = tail;
          this.head = head;
          this.group = new Group(body, back, eyes, tail, head);
          return this;
        };
        components.animate_eel = function (eel, time, step, start_x, width) {
          // Start from top if we're at the bottom 
          if (eel.tail.position.y > 800) eel.group.position.y = -100;

          var segment1, segment2, sinus, sway;
          var top_pos, bottom_pos;
          for (var i = 0; i < 4; i++) {
            segment1 = eel.body.segments[i];
            segment2 = eel.back.segments[i];
            // Pick a cylic value between -1 and 1
            sinus = Math.sin(time * 2 + i*1.3); 
            // Move the eel body segments side to side
            sway = sinus * width + start_x;   
            segment1.point.x = sway;       
            segment2.point.x = sway;

            if (i == 0) top_pos = segment1.point.x;
            if (i == 3) bottom_pos = segment1.point.x;
          }

          // Advance the eel up and down 
          eel.group.position.y += step;

          eel.eyes.position.x = top_pos;
          eel.tail.position.x = bottom_pos;
          eel.tail.segments[1].x = top_pos;
          eel.head.position.x = top_pos;
        };

        components.init_bubbles = function (n, width, height) {
          var bubbles = [];
          var pos, rad, bub;
          for (var i = 0; i < n; i++) {
            pos = new Point(Math.random() * width, Math.random() * height);
            rad = Math.random() * 10;
            bub = bubble(pos, rad);
            bubbles.push(bub);
          }
          return bubbles;
        };
        components.animate_bubbles = function (bubbles, step, width) { 
          for (var i = 0; i < bubbles.length; i++) {
            // reset if needed 
            if (bubbles[i].position.x > width) bubbles[i].position.x = 0;
            // otherwise move bubble 
            else bubbles[i].position.x += step;
          }
        };

        return components;
      };

      // Colors and gradient width percentages for the sea gradient 
      var sea_colors = ["#092B5A", "#09738A", "#78A890", "#9ED1B7"];

      // Make the background a nice gradient of blue/green
      var background = new Path.Rectangle({
        topLeft: new Point(0, 0), 
        topRight: new Point(width, 0), 
        bottomLeft: new Point(0, height), 
        bottomRight: new Point(width, height),
        fillColor: {
          gradient: {stops: sea_colors},
          origin: new Point(0, height / 2),
          destination: new Point(width, height / 2)
        }
      });

      var topLeft = createCircle(view.center.x, 0, 60, 'red');
      var topRight = createCircle(view.bounds.width, 0, 60, 'red');
      var bottomLeft = createCircle(view.center.x, view.bounds.height, 60, 'red');
      var bottomRight = createCircle(view.bounds.width, view.bounds.height, 60, 'red');
      var center = createCircle(view.center.x, view.center.y, 60, 'red');

      var ball = createCircle(-100, -100, 40, 'OrangeRed');


      var initCircles = [topLeft, bottomLeft, bottomRight, topRight];

      var user = new Shape.Circle({
        center: view.center,
        radius: 60,
        strokeColor: 'DarkGoldenRod',
        strokeWidth: 20
      });
      
      var countClicks = 0;

      function onMouseDown(event) {
          if (countClicks < 6) {
            switch (countClicks) {
              case 0:
                center.fillColor = 'green';
                center.strokeColor = 'green';
                view.draw();
                socket.emit('map', countClicks);
                countClicks++;
                break;
              case 1:
                bottomLeft.fillColor = 'green';
                bottomLeft.strokeColor = 'green';
                view.draw();
                socket.emit('map', countClicks);
                countClicks++;
                break;
              case 2:
                bottomRight.fillColor = 'green';
                bottomRight.strokeColor = 'green';
                view.draw();
                socket.emit('map', countClicks);
                countClicks++;
                break;
              case 3:
                topRight.fillColor = 'green';
                topRight.strokeColor = 'green';
                view.draw();
                socket.emit('map', countClicks);
                countClicks++;
                break;
              case 4:
                topLeft.fillColor = 'green';
                topLeft.strokeColor = 'green';
                view.draw();
                socket.emit('map', countClicks);
                countClicks++;
                break;
              case 5:
                center.remove();
                topLeft.remove();
                topRight.remove();
                bottomLeft.remove();
                bottomRight.remove();
                ball.position = new Point(500, 100);
                // Set up the slingshot arena 
                var arena = setup(size, width, height, urchin_radius, arm_size);
                arena.armTop.create();
                arena.armBottom.create();
                var slingshot = arena.slingshot();

                view.draw();
                socket.emit('ready');
                countClicks++;
                break;
            }
          }
      }

      socket.on('state', function (pos) {
        // rotated 90!!!!!!!
        // var y = map(state[0], -95, 95, 0, 768);
        // var x = map(state[1], 87, 200, 0, 1024);
        x[0] = pos[0][0];
        y[0] = pos[1][0];
        x[1] = pos[0][1];
        y[1] = pos[1][1];
        user.position = new Point(x[0],y[0]);
        ball.position = new Point(x[1],y[1]);

        // make the red line move
        // if ((user.position.x - user.radius - 10) < view.center.x) {
        //   wall.position.x = (user.position.x - user.radius -10);
        // }

        view.draw();
      });


    </script>

  </head>
  
  <body>

    <div id="viewport">
      <canvas id="myCanvas" resize="true"></canvas>
    </div>

  </body>

</html>